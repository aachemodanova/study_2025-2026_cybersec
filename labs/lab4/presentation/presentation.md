---
## Front matter
lang: ru-RU
title: Лабораторная работа №4
subtitle: "Кибербезопасность предприятия"
author:

  - НКНбд-01-22;
  - Аристид Жан,
  - Акопян Сатеник,
  - Кадров Виктор,
  - Нве Манге Хосе Херсон Мико,
  - Эспиноса Висилита Кристина Микаела,
  
  - НПИбд-01-22;
  - Стариков Данила,

  - НФИбд-02-22;
  - Чемоданова Ангелина

## i18n babel
babel-lang: russian
babel-otherlangs: english

## Formatting pdf
toc: false
toc-title: Содержание
slide_level: 2
aspectratio: 169
section-titles: true
theme: metropolis
header-includes:
 - \metroset{progressbar=frametitle,sectionpage=progressbar,numbering=fraction}
---

## Описание сценария

Во внутреннем сегменте организации необходимо получить доступ к контроллеру домена. У доменного пользователя «Flag», в одном из полей свойств пользователя необходимо найти флаг. 

Для прохождения данного сценария в первую очередь потребуется активная meterpreter-сессия с узлом в сегменте DMZ. 

Вариант получения meterpreter-сессии с корпоративным сайтом с помощью модуля wp_wpdiscuz_unauthenticated_file_upload представлен на скриншотах. 

## Описание сценария

![Параметры модуля wp_wpdiscuz_unauthenticated_file_upload](image/43.png){#fig:001 width=75%}

## Описание сценария

![Настройка и запуск meterpreter-сессии с корпоративным сайтом с помощью модуля wp_wpdiscuz_unauthenticated_file_upload](image/41.png){#fig:002 width=90%}

## Описание сценария

Вариант получения meterpreter-сессии с почтовым сервером с помощью модуля exchange_proxyshell_rce представлен на скриншотах. 

## Описание сценария

![Параметры модуля exchange_proxyshell_rce](image/7.png){#fig:003 width=75%}

## Описание сценария

![Настройка и запуск meterpreter-сессии с почтовым сервером с помощью exchange_proxyshell_rce](image/5.png){#fig:004 width=90%}

## Описание сценария

После получения сессии нужно проверить, находится ли эксплуатируемый узел в домене. Проверка выполняется с помощью команды sysinfo, которую нужно вводить в активную meterpreter-сессию. 

![Вывод команды для узла не в домене](image/39.png){#fig:005 width=90%}

## Описание сценария

![Вывод команды для узла под управлением контроллера домена](image/3.png){#fig:006 width=90%}

## Описание сценария

Можно свернуть активную сессию с помощью команды background (или bg) и просмотреть список активных сессий с помощью команды sessions.

![Информация о meterpreter-сессии с корпоративным сайтом](image/37.png){#fig:007 width=90%}

## Описание сценария

В случае получения сессии с корпоративным сайтом (модуль wordpress) для успешного выполнения дальнейших операций с атакуемой машиной необходимо повысить текущую сессию, повышение сессии в данном контексте не подразумевает повышение привилегий. 

Для повышения сессии необходимо: 

- свернуть активную сессию с помощью команды background (или bg); 
- прописать команду sessions -u {НОМЕР_СЕССИИ}; 
- зайти в новую сессию sessions {НОМЕР_СЕССИИ}. 

## Описание сценария

![Создание и запуск повышенной сессии](image/35.png){#fig:008 width=90%}

## Описание сценария

После повышения сессии можно переходить к процедуре поиска флага. 

В зависимости от того, с каким узлом в сегменте DMZ получена сессия 
(находится узел в доменной сети или нет), сценарий имеет различные 
вариации прохождений. Варианты прохождения представлены ниже. 

# Способы получения флага

## Доступ во внутренюю сеть через доменный узел

Данный подраздел описывает процесс получения флага через узел, который находится под управлением контроллера домена. 

В данном случае получить флаг можно с использованием команды net user, для чего в активной meterpreter-сессии перейти в shell-оболочку с помощью команды shell.

С помощью команды net user /domain вывести список всех доменных пользователей, далее вывести полную информацию о пользователе «Flag». В результате будет получен флаг в поле описания пользователя.

## Доступ во внутренюю сеть через доменный узел

![Список пользователей в домене](image/2.png){#fig:009 width=75%}

## Доступ во внутренюю сеть через доменный узел

![Получение флага](image/1.png){#fig:010 width=75%}

## Доступ во внутренюю сеть через узел не в домене

Данный подраздел описывает процесс получения флага через узел, который не находится под управлением контроллера домена. 

В первую очередь необходимо узнать, какие интерфейсы имеются на машине во внутренней сети, поиск выполняется в shell-оболочке с помощью команды ip a. 

![Маршрут до внутренней сети](image/34.png){#fig:011 width=90%}

## Доступ во внутренюю сеть через узел не в домене

Анализ выполнения команды показывает, что внутренняя сеть организации – это 10.10.10.0/24. 

Для продолжения атаки необходимо просканировать все доступные хосты во внутренней сети с помощью модуля Multi Gather Ping Sweep.

![Настройки модуля Multi Gather Ping Sweep](image/30.png){#fig:012 width=90%}

## Доступ во внутренюю сеть через узел не в домене

Произойдет сканирование внутренней сети организации и будут найдены все доступные хосты. 

Далее можно посмотреть ARP-таблицу на атакуемой машине с помощью команды arp в meterpreter-сессии.

![ARP-таблица на атакуемой машине](image/29.png){#fig:013 width=90%}

## Доступ во внутренюю сеть через узел не в домене

Поскольку целевой адрес атакуемого узла находится во внутренней подсети организации, то необходимо прописать маршрут до активной meterpreter-сессии. 

Далее выполнить проброс портов во внутреннюю сеть для дальнейшего выполнения команд через технику proxychains. Инструмент proxychains создает туннель через цепочку прокси-серверов и передает по данному туннелю пакет до адреса назначения. Для проброса портов во внутреннюю сеть используется команда run autoroute -s 10.10.10.0/24. 

## Доступ во внутренюю сеть через узел не в домене

![Сведения о добавлении маршрута](image/28.png){#fig:014 width=90%}

## Доступ во внутренюю сеть через узел не в домене

С помощью команды route print можно посмотреть активные маршруты в рамках текущей сессии. 

![Маршрут сканирования](image/27.png){#fig:015 width=90%}

## Доступ во внутренюю сеть через узел не в домене

Далее необходимо просканировать доступные хосты во внутренней подсети на наличие открытых портов с использованием модуля nmap. Так как сканируемые машины находятся во внутренней сети, то в первую очередь необходимо настроить прокси, через который будут проходить все запросы при сканировании. Для этого нужно применить и настроить модуль metasploit auxiliary/server/socks_proxy. 

Стоит обратить внимание, что основные параметры указанного модуля должны совпадать с конфигурационным файлом /etc/proxychains4.conf. Посмотреть содержимое файла можно в новом окне терминала с помощью 
команды cat /etc/proxychains4.conf. 

## Доступ во внутренюю сеть через узел не в домене

![Параметры в конфигурационном файле /etc/proxychains4.conf ](image/26.png){#fig:016 width=90%}

## Доступ во внутренюю сеть через узел не в домене

Далее вернуться к окну терминала с активной сессией и свернуть данную сессию с помощью команды bg, выбрать, настроить и запустить модуль socks_proxy: 

```
use auxiliary/server/socks_proxy 
set srvhost 127.0.0.1 
set srvport 1080 
set version 5 
run
```

## Доступ во внутренюю сеть через узел не в домене

![Настройка и запуск модуля](image/24.png){#fig:017 width=90%}

## Доступ во внутренюю сеть через узел не в домене

Далее в окне терминала, где просматривался файл /etc/proxychains.conf, запустить сканирование 100 самых часто используемых портов с помощью команды proxychains nmap –n –sT –Pn --top-ports 100 {IP}. 

Примечание: можно сканировать всю сеть, но это долгий процесс, рекомендуется производить сканирование по каждому IP-адресу из ARPтаблицы.

## Доступ во внутренюю сеть через узел не в домене

![Запуск сканирования](image/23.png){#fig:018 width=75%}

## Bruteforce пароля и использование ldapsearch 

В результате сканирования сети будет получен список открытых портов. На узле 10.10.10.20 обнаружен открытый порт 3389, который по умолчанию используется для подключения по протоколу RDP. Можно использовать указанный порт для доступа к контроллеру домена.

На главной странице портала организации обнаружена электронная почта для связи с менеджером. С большей долей вероятности, данная электронная почта находится в домене. В таком случае можно реализовать атаку перебором с использованием словаря паролей rockyou.txt, который находится по пути /usr/share/wordlists/. Запустить утилиту hydra, используя данную электронную почту, с помощью команды proxychains hydra –V –f- l manager1@ampire.corp –P rockyou.txt rdp://10.10.10.20. 

## Bruteforce пароля и использование ldapsearch 

![Запуск атаки перебором](image/22.png){#fig:019 width=90%}

## Bruteforce пароля и использование ldapsearch 

Мы запустили подбор пароля, однако это вычислительно затратная операция. Так как нужный пароль находится на 1028581 строке, то подбор занял бы намного больше времени, чем выделено на лабораторную. Потому мы решили воспользоваться им без подбора.

## Bruteforce пароля и использование ldapsearch 

![Подбор пароля](image/21.png){#fig:020 width=75%}

## Bruteforce пароля и использование ldapsearch 

![Подбор пароля](image/20.png){#fig:021 width=75%}

## Bruteforce пароля и использование ldapsearch 

Так как флаг находится в описании одного из доменных пользователей, то для получения флага не обязательно получать сессию с контроллером домена. Вывести информацию о всех доменных пользователях можно с помощью команды proxychains ldapsearch -H ldap://10.10.10.20 -D "manager1@ampire.corp" -W -b "dc=ampire,dc=corp". 

## Bruteforce пароля и использование ldapsearch 

![Использование команды ldapsearch](image/19.png){#fig:022 width=75%}

## Bruteforce пароля и использование ldapsearch 

Данные учетной записи получены при атаке перебором. В результатах найти параметр description.

## Bruteforce пароля и использование ldapsearch 

![Получение флага](image/18.png){#fig:023 width=75%}

## Zerologon CVE 2020-1472

Дополнительный возможный вектор атаки на котроллер домена заключается в эксплуатации уязвимости Zerologon (https://nvd.nist.gov/vuln/detail/cve-2020-1472). Для проверки подверженности узла данной уязвимости можно использовать утилиту crackmapexec. В результате выполнения команды proxychains crackmapexec smb 10.10.10.20 -M zerologon можно узнать NetBIOS name атакуемой машины, в данном случае – это AD.

## Zerologon CVE 2020-1472

![Проверка машины контроллера домена](image/17.png){#fig:024 width=75%}

## Zerologon CVE 2020-1472

Для эксплуатации данной уязвимости можно использовать модуль metasploit auxiliary/admin/dcerpc/cve_2020_1472_zerologon. В результате работы данного модуля будет сброшен пароль от системной учетной записи администратора контроллера домена – search auxiliary/admin/dcerpc/cve_2020_1472_zerologon.

## Zerologon CVE 2020-1472

![Запуск модуля](image/15.png){#fig:025 width=90%}

## Zerologon CVE 2020-1472

Далее для получения дампа хешей учетных записей контроллера домена можно воспользоваться командой, что необходимо выполнить в другом окне терминала.

## Zerologon CVE 2020-1472

![Дамп хешей учетных записей](image/14.png){#fig:026 width=75%}

## Zerologon CVE 2020-1472

В результате будет получен дамп хеша пароля от аккаунта администратора, данный хеш можно применить для подключения с помощью модуля metasploit /windows/smb/psexec.

Для получения сессии с контроллером домена указать обязательные параметры модуля, для чего вернуться в окно терминала с открытой msfconsole – use exploit/windows/smb/psexec.

## Zerologon CVE 2020-1472

![Получение сессии с контроллером домена](image/11.png){#fig:027 width=90%}

## Zerologon CVE 2020-1472

В активной meterpreter-сессии можно перейти в shell-оболочку с помощью команды shell.

![Переход в shell-оболочку](image/10.png){#fig:028 width=90%}

## Zerologon CVE 2020-1472

С помощью команды net user /domain вывести список всех доменных пользователей, далее вывести полную информацию о пользователе «Flag». В результате будет получен флаг в поле описания пользователя.

## Zerologon CVE 2020-1472

![Список пользователей в домене](image/9.png){#fig:029 width=90%}

## Zerologon CVE 2020-1472

![Получение флага](image/8.png){#fig:030 width=75%}


## Вывод

В ходе выполнения данной лабораторной работы мы выполнили тренировку “Захват контроллера домена”. В процессе выполнения работы освоили практические навыки выявления, анализа и атаки уязвимостей в различных системах.
